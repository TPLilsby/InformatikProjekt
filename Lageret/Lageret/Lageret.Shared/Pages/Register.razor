@page "/register"
@using Lageret.Shared.Services
@inject NavigationManager Navigation
@inject SessionService SessionService
@inject DatabaseUserService UserService

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow">
                <div class="card-body">
                    <h3 class="text-center mb-4">Opret Bruger</h3>

                    <EditForm Model="@registerModel" OnValidSubmit="HandleRegister">
                        <div class="mb-3">
                            <label for="username" class="form-label">Brugernavn</label>
                            <InputText id="username" class="form-control" @bind-Value="registerModel.Username" />
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Adgangskode</label>
                            <InputText id="password" type="password" class="form-control" @bind-Value="registerModel.Password" />
                        </div>

                        <div class="mb-3">
                            <label for="role" class="form-label">Vælg rolle</label>
                            <select id="role" class="form-select" @bind="registerModel.RoleName">
                                <option disabled selected value="">-- Vælg rolle --</option>
                                @foreach (var role in roles)
                                {
                                    <option value="@role">@role</option>
                                }
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success w-100">Registrer</button>
                    </EditForm>

                    <p class="mt-3 text-center">
                        Allerede bruger? <a href="/login">Log ind her</a>
                    </p>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger text-center mt-3" role="alert">
                            @errorMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterModel registerModel = new();
    private string errorMessage;
    private List<string> roles = new();

    protected override async Task OnInitializedAsync()
    {
        roles = await UserService.GetRoleNamesAsync();
    }

    private async Task HandleRegister()
    {
        var success = await UserService.RegisterAsync(registerModel.Username, registerModel.Password, registerModel.RoleName);

        if (success)
        {
            Navigation.NavigateTo("/login");
        }
        else
        {
            errorMessage = "Fejl under registrering. Brugernavn eksisterer måske allerede.";
        }
    }

    private class RegisterModel
    {
        public string Username { get; set; }
        public string Password { get; set; }
        public string RoleName { get; set; }
    }
}
